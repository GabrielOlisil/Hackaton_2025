<!doctype html>
<html lang="pt-br">

<head>
    <style>
        /* Adicionamos um estilo para a lista de locais */
        .places-list {
            max-height: 80vh;
            /* Altura máxima da lista */
            overflow-y: auto;
            /* Barra de rolagem se necessário */
        }

        #map {
            height: 90vh;
            /* Mapa ocupa quase toda a altura */
        }
    </style>
</head>

<body>
    <main class="container-fluid mt-2">
        <div class="row">
            <div class="col-md-4">
                <h2 class="h4">Comércios em Ariquemes</h2>
                <div class="list-group places-list">

                    {% for place in places %}
                    <div class="list-group-item">
                        <h5 class="mb-1">{{ place.id }}</h5>
                        <h5 class="mb-1">{{ place.name }}</h5>
                        <p class="mb-1 text-muted small">{{ place.vicinity }}</p>
                        <small>Avaliação: {{ place.rating }} ({{ place.user_ratings_total }} votos)</small>
                    </div>
                    {% empty %}
                    <p class="text-muted">Nenhum comércio encontrado.</p>
                    {% endfor %}

                </div>
            </div>

            <div class="col-md-8">
                <div id="map"></div>
            </div>
        </div>
    </main>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAo8nGPBaqztHCC6Ktyt8jdIUOUjikz1SM&callback=initMap">
        </script>

    <script>
        // O Django vai inserir os dados dos locais aqui
        const placesData = JSON.parse('{{ places_json|escapejs }}');

        // Função para formatar os tipos continua a mesma...
        function formatPlaceTypes(types) {
            // ... (código da função de tradução) ...
        }

        async function initMap() {
            const ariquemesCoords = { lat: -9.9133, lng: -63.0410 };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: ariquemesCoords,
            });

            // O JavaScript NÃO FAZ MAIS O FETCH!
            // Ele já recebe os dados prontos na variável 'placesData'.

            // O painel de detalhes pode ser removido ou reaproveitado para mostrar info ao clicar
            // const detailsDiv = document.getElementById("place-details");

            placesData.forEach(place => {
                const marker = new google.maps.Marker({
                    position: place.location,
                    map: map,
                    title: place.name,
                });

                // A interatividade de clique continua funcionando
                marker.addListener("click", () => {
                    // Exemplo: mostrar um 'alert' ou preencher um painel de detalhes
                    const tipoDoLugar = formatPlaceTypes(place.types);
                    alert(
                        `Nome: ${place.name}\n` +
                        `Tipo: ${tipoDoLugar}\n` +
                        `Endereço: ${place.vicinity}`
                    );
                });
            });
        }
    </script>
</body>

</html>