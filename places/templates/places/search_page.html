{% extends "places/base.html" %}

{% block extra_css %}
<style>
    /* Mesmos estilos de autocomplete que usamos antes */
    .autocomplete-results {
        position: relative;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 250px;
        overflow-y: auto;
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
        background-color: #e9e9e9;
    }
</style>
{% endblock %}


{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <form id="product-search-form" method="GET" action="{% url 'search_page' %}" class="mb-4">
            <div class="input-group autocomplete-results">
                <input type="text" id="product-search-input" name="q" class="form-control"
                    placeholder="Digite o nome de um produto..." value="{{ query|default:'' }}" autocomplete="off">
                <button class="btn btn-success" type="submit">Buscar</button>
                <div id="product-results" class="autocomplete-items"></div>
            </div>
        </form>

        {% if query %}
        <h4>Produtos encontrados para "{{ query }}":</h4>
        <div class="list-group">
            {% for product in products %}
            <a href="{% url 'product_locations' product.id %}" class="list-group-item list-group-item-action">
                {{ product.name }}
            </a>
            {% empty %}
            <div class="p-3 text-center">
                <p class="text-muted">Nenhum produto encontrado com o nome "<strong>{{ query }}</strong>".</p>
                <a href="{% url 'add_sighting' %}?product_name={{ query }}" class="btn btn-outline-primary mt-2">
                    Seja o primeiro a cadastrar este produto!
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const searchForm = document.getElementById('product-search-form');
    const searchInput = document.getElementById('product-search-input');
    const resultsBox = document.getElementById('product-results');

    searchInput.addEventListener('keyup', function () {
        const query = searchInput.value;
        resultsBox.innerHTML = '';

        if (query.length < 2) {
            resultsBox.style.display = 'none';
            return;
        }

        fetch(`/api/search-products/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                resultsBox.style.display = 'block';
                data.forEach(productName => {
                    const div = document.createElement('div');
                    div.textContent = productName;
                    div.addEventListener('click', function () {
                        // Ao clicar em uma sugestão:
                        searchInput.value = productName; // Preenche o input
                        resultsBox.innerHTML = '';         // Limpa as sugestões
                        resultsBox.style.display = 'none'; // Esconde a caixa
                        searchForm.submit();               // Envia o formulário
                    });
                    resultsBox.appendChild(div);
                });
            });
    });

    // Esconde os resultados se o usuário clicar fora
    document.addEventListener('click', function (e) {
        if (e.target !== searchInput) {
            resultsBox.style.display = 'none';
        }
    });
</script>
{% endblock %}